# Crunched 2.0

A simplified Excel add-in with an AI agent that can read and write to spreadsheets via natural language.

## Setup

### Prerequisites

- Node.js (v18+)
- Python 3.11+
- [uv](https://github.com/astral-sh/uv) for Python package management
- Excel (desktop or Office 365 web)

### 1. Install frontend dependencies

```bash
cd crunched-addin
npm install
```

### 2. Install backend dependencies

```bash
cd backend
uv sync
```

### 3. Run the backend

```bash
cd backend
ANTHROPIC_API_KEY=your-api-key uv run uvicorn main:app --reload --port 8000 \
  --ssl-keyfile=$HOME/.office-addin-dev-certs/localhost.key \
  --ssl-certfile=$HOME/.office-addin-dev-certs/localhost.crt
```

Note: The SSL certificates are generated by the Office add-in tooling when you first run `npm start`. We reuse them for the backend so both frontend and backend are on HTTPS.

### 4. Run the frontend (opens Excel with add-in)

```bash
cd crunched-addin
npm start
```

### 5. Use the add-in

1. In Excel, click "Show Task Pane" on the Home ribbon
2. Type a message like "What's in cell A1?" or "Write 'Hello' to B1"
3. The agent reads/writes to your spreadsheet

---

## Architecture

```
┌─────────────────────────────────────────┐
│  Excel Add-in (React + TypeScript)      │
│  - Chat UI                              │
│  - Office.js for Excel operations       │
│  - Executes tool calls from backend     │
└─────────────────────────────────────────┘
                    │ HTTPS
                    ▼
┌─────────────────────────────────────────┐
│  Python Backend (FastAPI)               │
│  - /chat endpoint                       │
│  - Claude agent with tool definitions   │
│  - Returns tool_calls or final response │
└─────────────────────────────────────────┘
```

**Why this split?**

Office.js (Excel API) only runs in the browser context. The backend cannot directly access Excel. So:

- **Frontend** = hands (executes Excel operations)
- **Backend** = brain (Claude decides what to do)

---

## Design Decisions

### 1. Native tool use over JSON prompting

We use Anthropic's native tool use API rather than prompting Claude to output JSON. This guarantees the response format is always correct — no parsing errors or malformed JSON. The API returns structured Python objects, not text we hope is valid JSON.

### 2. Targeted reads for scalability

The agent never reads an entire worksheet. It requests specific ranges (e.g., `A1:B10`), so the system works with workbooks of any size. A 100k-row spreadsheet won't crash the add-in because we only read what's needed.

### 3. Server-side session state

Conversation history is stored on the backend, keyed by `session_id`. The frontend only sends the session ID with each request — not the full conversation history. This keeps payloads small and gives the backend full control over state. In production, you'd swap the in-memory dict for Redis.

### 4. HTTPS everywhere

Office add-ins require HTTPS. We reuse the development certificates generated by `office-addin-dev-certs` for both the frontend and backend, avoiding mixed-content browser errors.

### 5. Formulas over computed values

When the user asks for calculations (sums, averages, etc.), the agent writes Excel formulas (e.g., `=SUM(A1:A10)`) rather than computing the result itself. This keeps the spreadsheet dynamic — when inputs change, results update automatically. This is enforced via the system prompt.

---

## Project Structure

```
├── crunched-addin/          # Excel add-in (React + TypeScript)
│   ├── src/taskpane/
│   │   ├── components/App.tsx   # Chat UI + tool execution loop
│   │   └── taskpane.ts          # Office.js functions (readRange, writeRange, getWorkbookInfo)
│   └── manifest.xml             # Add-in configuration
│
├── backend/                 # Python backend
│   ├── main.py              # FastAPI app
│   ├── agent.py             # Claude agent logic
│   ├── tools.py             # Tool definitions for Claude
│   └── models.py            # Pydantic request/response models
```

---

## Future Improvements

- `get_selected_range` tool — let Claude see what the user has highlighted
- Better error handling — surface Office.js errors to the user
- Streaming responses — show Claude's thinking in real-time
- Persistent sessions — use Redis instead of in-memory dict